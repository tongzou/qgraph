<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>qgraph Test</title>
	<script src="../node_modules/lodash/lodash.js"></script>
	<script src="../lib/canvg.js"></script>
	<script src="../dist/qgraph.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<input type="button" value="Performance Test" onclick="testPerformance()">
<input type="button" value="Toggle Zoom" onclick="toggleZoom()">
<input type="button" value="Test Image Capture" onclick="testImageCapture()">
<input type="button" value="Start Viewer" onclick="startViewer()"/>
<input type="button" value="Destroy Viewer" onclick="destroyViewer()"/>
<div id="graph-demo" style="position:absolute;left:10px;right:10px;top:10px;bottom:10px;margin-top:20px"></div>
<script type="text/javascript">
var qg = window["qgraph"].default;
var graphConfig = {
	mode: 0,
	edgeTypes: [
		{name: 'Default', shape: { type: 'manhattan', round: 0, orthogonal: true}, labelConfig: { align: 'center', backgroundStyle: 'fill:white;stroke-width:0', geometry: {x: 0.5}}}
	],
    nodeTypes: [
		{name: "Error"},
		{
			name: 'Start',
			className: 'start',
			shape: {
				name: "Ellipse",
				width: 60,
				height: 60
			}
		},
		{
			name: 'Assignment',
			className: 'assignment',
			shape: {
				name: "Rectangle",
				width: 120,
				height: 60
			},
			labelConfig: {
				ns: 'label',
				align: "center",
				fontSize: 12,
				backgroundStyle: 'fill:yellow;stroke-width:0',
				width: 0.9,
				textStyle: "fill:#888888"
			}
		},
		{name: 'Decision'},
		{name: 'SubProcess'},
		{name: 'RouterPool', resizable: true},
		{name: 'SwimLane'},
		{
			name: 'End',
			className: 'end',
			shape: {
				name: "Ellipse",
				width: 60,
				height: 60
			}
		},
		{name: 'Fork'},
		{name: 'Annotation', resizable: true, htmlLabel: true}
	]
};

var viewConfig = {
	isDefault: true,
	maskOpacity: 0
};

var model = {
    nodes: [
	    {type:'Assignment', label:'simpleFlow1', id:'1', x:100, y:100},
	    {type:'Assignment', label:'[Utility]', id:'2', x:100, y:250},
	    {type:'Start', label:'', id:'3', x:300, y:500},
	    {type:'End', label:'', id:'4', x:500, y:60}
    ],
	edges: [
		{from: '1', to:'2', label:'edge'}
	]
};


qg.Utils.debug();
var graph;

function startViewer() {
	graph = new qg.Graph('myGraph', graphConfig, model);
	new qg.SVGRenderer('default', document.getElementById('graph-demo'), viewConfig, graph).render();
}

function destroyViewer(){
    ViewerManager.destroyViewer();
}

function createTestModel(size) {
	var model = {nodes:[], edges: []};
	var gap = 20;
	var x = gap, y = gap;
	for (var i = 0; i < size; i++) {
		model.nodes.push({type: vertexTypes[_.random(0, vertexTypes.length-1)].name, label: "s" + (i+1), x: x, y: y});
		x += 120 + gap;
		if (x > 1000) {
			x = gap;
			y += 60 + gap;
		}
	}
	return model;
}

function createShape(name, type, indicators) {
	return {type: type, label:name, id: name, indicators: indicators};
}

function createChildren(model, node, size, level, maxlevel) {
	if (level >= maxlevel) return;
	var v1, id;
	var fromid = _.isArray(node) ? node[0].id : node.id;
	for (var i = 0; i < size; i++) {
		id = fromid + "-" + level + ":" + i;
		v1 = createShape(id, "Assignment", [{className: 'SLAModifier'}]);
		model.nodes.push(v1);
		model.edges.push({type:'Transition', from: fromid, to:id, id:fromid+id});
		createChildren(model, v1, size, level+1, maxlevel);
	}
}

function testUpdate() {
    var model = {nodes: [
        {type:'root', label:'test1', id:'Rule-Decision-Strategy'},
        {type:'StrategySet', label:'Strategy Set', id:'StrategySet1', tooltip:'jji', pathKey:'RH_2.pyModelProcess.pyShapes(StrategySet1)',
            indicators: [{className: 'summary', label: 'jji'},{className: 'dataEnrichment'}], x:0.48, y:0.48}
    ],
        edges: [] };
    ViewerManager.getViewer().update(model);
}

function testImageCapture() {
    ViewerManager.executeAction("saveFlowImage");
}


function toggleZoom() {
	var graph = ViewerManager.currentViewer.graph;
	var currentScale = graph.scale();
	if (currentScale == 1.0)
		ViewerManager.executeAction({name: "zoom", zoom: 2});
	else
		ViewerManager.executeAction({name: "zoom", zoom: 'actual'});
}

function testPerformance() {
	var myClass = function(name) { this.name = name; };
	myClass.prototype.sayName = function() { console.log(this.name); };
	var classes = [];
	var start = new Date().getTime();
	for (var i = 0; i < 100000 	; i++)
		classes.push(new myClass("name" + i));
	var end = new Date().getTime();
	alert((end-start)/1000);
}
</script>
</body>
</html>
