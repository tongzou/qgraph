<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>qgraph Test</title>
	<script src="../node_modules/lodash/lodash.js"></script>
	<script src="../lib/canvg.js"></script>
	<script src="../dist/qgraph.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<body>
<input type="button" value="Performance Test" onclick="testPerformance()">
<input type="button" value="Toggle Zoom" onclick="toggleZoom()">
<input type="button" value="Test Image Capture" onclick="testImageCapture()">
<input type="button" value="Start Viewer" onclick="startViewer()"/>
<input type="button" value="Destroy Viewer" onclick="destroyViewer()"/>
<input type="button" value="Start Dispatcher" onclick="enableDispatcher(true)"/>
<input type="button" value="Stop Dispatcher" onclick="enableDispatcher(false)"/>
<div id="graph-demo" style="position:absolute;left:20px;right:20px;top:20px;bottom:20px;margin-top:50px">
	<!--div ns="root.node" data="node1" style="position:absolute;left:100px;top:100px;background-color:#0e72b5; width:120px; height:60px"><div ns="label">my label1</div></div>

	<div ns="root.node" data="node2" style="position:absolute;left:300px;top:100px;background-color:#0e72b5; width:120px; height:60px"><div ns="label">my label2</div></div>
	-->
</div>
<script type="text/javascript">
var qg = window["qgraph"].default;
var graphConfig = {
	mode: 0,
	edgeTypes: [
		{name: 'Default', shape: { type: 'manhattan', round: 20, orthogonal: true}}
	],
    nodeTypes: [
		{name: "Error"},
		{
			name: 'Start',
			className: 'start',
			shape: {
				name: "Ellipse",
				width: 60,
				height: 60
			}
		},
		{
			name: 'Assignment',
			className: 'assignment',
			shape: {
				name: "Rectangle",
				width: 120,
				height: 60
			},
			labelConfig: {
				ns: 'label',
				align: "center",
				width: 0.9,
				textStyle: "fill:#888888"
			}
		},
		{name: 'Decision'},
		{name: 'SubProcess'},
		{name: 'RouterPool', resizable: true},
		{name: 'SwimLane'},
		{
			name: 'End',
			className: 'end',
			shape: {
				name: "Ellipse",
				width: 60,
				height: 60
			}
		},
		{name: 'Fork'},
		{name: 'Annotation', resizable: true, htmlLabel: true}
	]
};

var viewConfig = {
	isDefault: true,
	maskOpacity: 0
};

var model = {
    nodes: [
	    {type:'Assignment', label:'simpleFlow1', id:'ASSIGNMENT63', x:100, y:150},
	    {type:'Assignment', label:'[Utility]', id:'Utility2', x:100, y:300},
	    {type:'Start', label:'', id:'Start1', x:300, y:500},
	    {type:'End', label:'', id:'END52', x:500, y:60}
    ],
	edges: [
		{from: 'Start1', to:'ASSIGNMENT63'},
		{from: 'ASSIGNMENT63', to:'END52'}
	]
};


qg.Utils.debug();
var graph;

function startViewer() {
	graph = new qg.Graph('myGraph', graphConfig, model);
	new qg.SVGRenderer('default', document.getElementById('graph-demo'), viewConfig).graph(graph).render();
}

function destroyViewer(){
    ViewerManager.destroyViewer();
}

function createTestModel(size) {
	var model = {nodes:[], edges: []};
	var gap = 20;
	var x = gap, y = gap;
	for (var i = 0; i < size; i++) {
		model.nodes.push({type: vertexTypes[_.random(0, vertexTypes.length-1)].name, label: "s" + (i+1), x: x, y: y});
		x += 120 + gap;
		if (x > 1000) {
			x = gap;
			y += 60 + gap;
		}
	}
	return model;
}

function createShape(name, type, indicators) {
	return {type: type, label:name, id: name, indicators: indicators};
}

function createChildren(model, node, size, level, maxlevel) {
	if (level >= maxlevel) return;
	var v1, id;
	var fromid = _.isArray(node) ? node[0].id : node.id;
	for (var i = 0; i < size; i++) {
		id = fromid + "-" + level + ":" + i;
		v1 = createShape(id, "Assignment", [{className: 'SLAModifier'}]);
		model.nodes.push(v1);
		model.edges.push({type:'Transition', from: fromid, to:id, id:fromid+id});
		createChildren(model, v1, size, level+1, maxlevel);
	}
}

function testUpdate() {
    var model = {nodes: [
        {type:'root', label:'test1', id:'Rule-Decision-Strategy'},
        {type:'StrategySet', label:'Strategy Set', id:'StrategySet1', tooltip:'jji', pathKey:'RH_2.pyModelProcess.pyShapes(StrategySet1)',
            indicators: [{className: 'summary', label: 'jji'},{className: 'dataEnrichment'}], x:0.48, y:0.48}
    ],
        edges: [] };
    ViewerManager.getViewer().update(model);
}

function testImageCapture() {
    ViewerManager.executeAction("saveFlowImage");
}


function toggleZoom() {
	var graph = ViewerManager.currentViewer.graph;
	var currentScale = graph.scale();
	if (currentScale == 1.0)
		ViewerManager.executeAction({name: "zoom", zoom: 2});
	else
		ViewerManager.executeAction({name: "zoom", zoom: 'actual'});
}

function testPerformance() {
	var myClass = function(name) { this.name = name; };
	myClass.prototype.sayName = function() { console.log(this.name); };
	var classes = [];
	var start = new Date().getTime();
	for (var i = 0; i < 100000 	; i++)
		classes.push(new myClass("name" + i));
	var end = new Date().getTime();
	alert((end-start)/1000);
}

var dispatcher;
function enableDispatcher(enable) {
	if (enable) {
		if (!dispatcher) {
			dispatcher = new qg.EventDispatcher(document.getElementById('graph-demo'), "testing", [0.5, 4]);
			dispatcher.register('drag*', function(type, ns, data, pos, event) {
				console.log('type=' + type + ';ns=' + ns + ';data=' + data.getAttribute('data') + ';pos=' + pos + ';event data=' + event.rootTarget.getAttribute('data'));
			});
			dispatcher.register('zoom*', function(type, ns, data, pos, event) {
				console.log(type + ' ' + ns + ' ' + data + ' ' + event.scale);
			});
		}
		dispatcher.start();
	} else if (dispatcher) {
		dispatcher.stop();
	}
}
</script>
</body>
</html>
